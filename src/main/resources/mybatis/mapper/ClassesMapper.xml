<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.ems.core.mapper.ClassesMapper">
    <select id="getClassesInfo" parameterType="com.chen.ems.core.model.ClassesVO" resultType="com.chen.ems.core.model.ClassesVO">
        SELECT c.id, c.name,m.major_name as major,o.name as college, (select count(*) from ems_user left join ems_classes ec on ems_user.classes = ec.id where ems_user.classes = c.id) as studentNum
        FROM ems_classes c LEFT JOIN ems_major m ON c.major=m.id LEFT JOIN ems_college o on m.college = o.id
        <where>
            <if test="name !=null and name != ''">
                and c.name = #{name}
            </if>
            <if test="major !=null and major != ''">
                and major = (select id from ems_major where major_name = #{major})
            </if>
            <if test="college !=null and college != ''">
                and major in (SELECT ems_major.id FROM ems_major LEFT JOIN ems_college on ems_major.college = ems_college.id where ems_college.name=#{college})
            </if>
        </where>
    </select>

    <update id="putClasses" parameterType="com.chen.ems.core.model.ClassesVO">
        update ems_classes set name=#{name},major=(select id from ems_major where ems_major.major_name = #{major})
        where id=#{id}
    </update>

    <insert id="addClasses" parameterType="com.chen.ems.core.model.ClassesVO" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into ems_classes(name, major)
        values (#{name},(select id from ems_major where ems_major.major_name = #{major}))
    </insert>
</mapper>